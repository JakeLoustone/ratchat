<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		
		<title>ratchat</title>
		<link rel="stylesheet" href="https://unpkg.com/98.css">
		<style>
	
		body {
			height: 100%;
			margin: 0;
			overflow: hidden;
		}

		.window-body {
    		display: flex;
			flex-direction: column;
			height: calc(100vh - 2rem);
			margin: 0 !important;
			padding: 0.2rem;
		}

		#form{
			display: flex;
			gap: 0.25rem;
			padding-top: 0.25rem;
		}

		#input {
			border: none;
			height: 2rem;
			padding: 0 1rem;
			flex-grow: 1;
			margin: 0.25rem;
			font-size: large;
		}
		
		#input:focus {
			outline: none;
		}

		.user-sidebar {
			width: 10%;
			min-width: 10rem;
			background: white;
			box-shadow: inset -0.0625rem -0.0625rem #fff, 
						inset 0.0625rem 0.0625rem #0a0a0a, 
						inset -0.125rem -0.125rem #dfdfdf, 
						inset 0.125rem 0.125rem #808080;
			padding: 0.3125rem;
			margin-top: 0.25rem;
			margin-bottom: 0.25rem;			
			overflow-y: auto;
			flex-shrink: 0;
		}

		#user-list {
			list-style: none;
			padding: 0;
			margin: 0.25rem;
			font-size: large
		}

		.user-status {
			font-size: larger;
			color: #444;
			margin-left: 0.3125rem;
		}

		.status-orb {
			display: inline-block;
			width: 0.7rem;
			height: 0.7rem;
			border-radius: 50%;
			margin-right: 0.375rem;
			border: 0.0625rem solid rgba(0,0,0,0.2);
		}

		.orb-online {
			background: radial-gradient(circle at 0.1875rem 0.1875rem, #52ff52, #008000);
			box-shadow: 0.0625rem 0.0625rem 0.0625rem rgba(0,0,0,0.3);
		}

		.orb-afk {
			background: radial-gradient(circle at 0.1875rem 0.1875rem, #ffb84d, #ff8c00);
    		box-shadow: 0.0625rem 0.0625rem 0.0625rem rgba(0,0,0,0.3);
		}

		#messages-container {
			flex-grow: 1;
			overflow-y: auto;
			background: white;
			box-shadow: inset -0.0625rem -0.0625rem #fff,
						inset 0.0625rem 0.0625rem #0a0a0a, 
						inset -0.125rem -0.125rem #dfdfdf, 
						inset 0.125rem 0.125rem #808080;
			padding: 0.625rem;
			margin-top: 0.25rem;
			margin-bottom: 0.25rem;
			display: flex;
			flex-direction: column;
		}

		#messages {
			list-style-type: none;
			margin: 0;
			padding: 0;
			margin-top: auto;
			font-size: large;
		}

		#messages > li {
			padding: 0.2rem 0.5rem; 
		}

		#messages > .s-li {
			padding: 0.2rem 0.5rem; 
			color: red;
			white-space: pre-wrap;
		}

		#messages > .i-li {
			padding: 0.2rem 0.5rem; 
			color: darkslategrey;
			white-space: pre-wrap;
		}

		#messages > .w-li {
			padding: 0.2rem 0.5rem;
			color: darkblue;
			white-space: pre-wrap;
		}

		#messages > .a-li {
			padding: 0.2rem 0.5rem; 
			color: #6eab6e;
			white-space: pre-wrap;
		}

		#messages .user-name {
			font-weight: bold;
			margin-right: 0.15rem;
			margin-left: 0.15rem;
			color: var(--user-color, black);
		}

		#messages > li:hover {
			cursor: pointer;
			background-color: rgba(0, 0, 0, 0.05);
		}
		</style>
	</head>

	<body>
    <div class="window" style="width: 99.7%; height: 100vh; display: flex; flex-direction: column;">
        <div class="title-bar">
            <div class="title-bar-text">ratchat</div>
            <div class="title-bar-controls">
                <button aria-label="Minimize"></button>
                <button aria-label="Maximize"></button>
                <button aria-label="Close"></button>
            </div>
        </div>

        <div class="window-body">
            <div style="display: flex; flex-direction: row; flex-grow: 1; overflow: hidden; gap: 0.25rem;">
                <div id="messages-container">
                    <ul id="messages"></ul>
                </div>
                
                <div id="user-sidebar" class="user-sidebar">
                    <ul id="user-list" class="user-list"></ul>
                </div>
            </div>

            <form id="form" action="">
                <input id="input" type="text" autocomplete="off" />
                <button type="submit">Send</button>
            </form>
        </div>
    </div>
	<script src="https://cdn.socket.io/4.8.3/socket.io.min.js"></script> 

	<script>
		const localGUID = localStorage.getItem('ratGUID');
		const socket = io({
		    auth: {
			token: localGUID
		    }
		});
		const form = document.getElementById('form');
		const input = document.getElementById('input');
		const messages = document.getElementById('messages');

		//Helper function for non user messages
		const systemMessage = (msg, className) => {
			const item = document.createElement('li');
			const msgContainer = document.getElementById('messages-container');
			item.classList.add(className);
			item.textContent = msg;
			messages.appendChild(item);
			msgContainer.scrollTop = msgContainer.scrollHeight;
		};

		//Client submission
		form.addEventListener('submit', (e) => {
			e.preventDefault();
			
			//null after trim return
			const val = input.value.trim()
			if (!val) return;

			//Export command
			if (val.startsWith('/export') && val.length === 7) {
				const oldGUID = localStorage.getItem('ratGUID');
				if (!oldGUID) {
       				systemMessage("you ain't got no ID, you ain't gettin in this bar.", 's-li');
       				return;
				}
				systemMessage(`Your GUID is: ${oldGUID}`, 'i-li')
				input.value = '';
				return;
			}

			//Clear command
			if(val.startsWith('/clear') && val.length === 6 || val.startsWith('/clr') && val.length === 4){
				messages.replaceChildren();
				input.value = '';
				return;
			}

			//Send message
			socket.emit('toServerChat', val, () => {
				input.value = '';
			});
		});

		//Identity events
		socket.on('identity', (identity) => {
			if (identity && identity.guid === 'RESET_IDENTITY'){
				console.log('Identity cleared from local storage');
				localStorage.removeItem('ratGUID');
			} else if(identity && identity.guid) {
				console.log('Identity synced:', identity);
				localStorage.setItem('ratGUID', identity.guid);
			} else{
				console.log('identity load error')
			}
		});

		//User list events
		socket.on('userlist', (uList) => {
			const userListElement = document.getElementById('user-list');
			userListElement.innerHTML = ''; // Clear current list

			uList.forEach(user => {
				const li = document.createElement('li');
				li.style.marginBottom = "0.125rem";
				
				const userColor = user.nick.substring(0, 7);
				const userName = user.nick.substring(7);
				const orb = user.isAfk ? 'orb-afk' : 'orb-online';
				const orbLabel = user.isAfk ? 'AFK' : 'Online'
				const statusText = user.status ? `<div style="font-size:small; color: #444; margin-left: 0.375rem;">${user.status}</div>` : '';

				li.innerHTML = `
					<span class="status-orb ${orb}" title="${orbLabel}"></span><span style="color: ${userColor}; font-weight: bold;">${userName}</span>
					${statusText}
				`;
				userListElement.appendChild(li);
					});
		});

		//Delete message events
		socket.on('deleteMsg', (msgArray) => {
			if(!Array.isArray(msgArray)){
				return;
			}
			msgArray.forEach(id => {
				const target  = document.querySelector(`li[data-id="${id}"]`)
				if(target){
					target.remove();
				}
			});
		});


		//message type to css class
		const toClass = {
			'toClientChat': '',
			'toClientError': 's-li',
			'toClientInfo': 'i-li',
			'toClientWelcome': 'w-li',
			'toClientAnnouncement': 'a-li'
		};

		//message renderer
		const renderMessage =(msg) =>{
			
			const item = document.createElement('li');
			const msgContainer = document.getElementById('messages-container');

			//message type classification
			const className = toClass[msg.type];
   			if (className) item.classList.add(className);

			//Date constructor
			if(msg.id !== -1){
			const date = new Date(msg.timestamp);
			const dateStr = date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
			const timeSpan = document.createElement('span');
				timeSpan.textContent = dateStr;
				timeSpan.style = "color:grey; font-size:small; margin-right:0.5rem"
			item.appendChild(timeSpan);
			}

			//Nickname constructor and styling
			if(msg.id !== -1 && msg.author){
			const userName = msg.author.substring(7);
			const userColor = msg.author.substring(0,7);
			const nameSpan = document.createElement('span');
            nameSpan.className = "user-name";
				nameSpan.style.setProperty('--user-color', userColor);
				nameSpan.textContent = userName + ": ";
			item.appendChild(nameSpan)
			//set hover msg ID and data ID
			item.setAttribute('title', `Msg ID: ${msg.id}`);
			item.setAttribute('data-id', msg.id);
			}

			//Message content
			const contentSpan = document.createElement('span')
				contentSpan.textContent = msg.content;
			item.appendChild(contentSpan);

			//finalize
			messages.appendChild(item);
			msgContainer.scrollTop = msgContainer.scrollHeight;
		};

		//message listeners
		socket.on('toClientChat', renderMessage);
		socket.on('toClientError', renderMessage);
		socket.on('toClientInfo', renderMessage);
		socket.on('toClientWelcome', renderMessage);
		socket.on('toClientAnnouncement', renderMessage);
	</script>
	</body>
</html>