<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<meta name="robots" content="noindex, nofollow">
		
		<title>ratchat</title>
		<link rel="stylesheet" href="https://unpkg.com/98.css">
		<style>
	
		body {
			height: 100%;
			margin: 0;
			padding: 0rem;
			box-sizing: border-box;
			overflow: hidden;
		}

		.window{
			top: 0.25rem;
			left: 0.25rem;
			right: 0.25rem;
			bottom: 0.25rem;
			display: flex;
			flex-direction: column;
			margin: 0 !important;
			width: auto !important;
		}

		.window-body {
			display: flex;
			flex-direction: column;
			height: calc(100vh - 2rem);
			margin: 0 !important;
			padding: 0.2rem;
		}

		#form{
			display: flex;
			gap: 0;
			padding-top: 0.25rem;
		}

		#input {
			border: none;
			height: 2rem;
			padding: 0, 0.5rem;
			flex-grow: 1;
			font-size: large;
			margin-right: 0.3rem;
		}
		
		#input:focus {
			outline: none;
		}

		#user-sidebar {
			width: 10%;
			min-width: 10rem;
			background: white;
			box-shadow: 
						inset -0.0625rem -0.0625rem #fff, 
						inset 0.0625rem 0.0625rem #0a0a0a, 
						inset -0.125rem -0.125rem #dfdfdf, 
						inset 0.125rem 0.125rem #808080;
			padding: 0.3125rem;
			margin-top: 0.25rem;
			margin-bottom: 0.25rem;			
			overflow-y: auto;
			flex-shrink: 0;
			display: flex;
			flex-direction: column;
			overflow: hidden;
			scrollbar-width: none; /* Firefox */
			-ms-overflow-style: none; /* IE/Edge */
		}

		#user-sidebar::-webkit-scrollbar {
			display: none; /* Chrome/Safari */
		}

		#user-list {
			flex-grow: 1; /* Pushes the lurker div down */
			overflow-y: auto; /* Only the names scroll */
			list-style: none;
			padding: 0;
			margin: 0.25rem;
			font-size: large;
			scrollbar-width: none;
			-ms-overflow-style: none; /* IE/Edge */
		}

		#user-list::-webkit-scrollbar {
			display: none;
		}
		.user-status {
			font-size: larger;
			color: #444;
			margin-left: 0.3125rem;
		}

		.status-orb {
			display: inline-block;
			width: 0.7rem;
			height: 0.7rem;
			border-radius: 50%;
			margin-right: 0.375rem;
			border: 0.0625rem solid rgba(0,0,0,0.2);
		}

		.orb-online {
			background: radial-gradient(circle at 0.1875rem 0.1875rem, #52ff52, #008000);
			box-shadow: 0.0625rem 0.0625rem 0.0625rem rgba(0,0,0,0.3);
		}

		.orb-afk {
			background: radial-gradient(circle at 0.1875rem 0.1875rem, #ffb84d, #ff8c00);
			box-shadow: 0.0625rem 0.0625rem 0.0625rem rgba(0,0,0,0.3);
		}
		#lurker-status{
			font-size: small;
			min-height: 1rem;
			flex-shrink: 0;
			text-align: center;
		}

		#messages-container {
			flex-grow: 1;
			overflow-y: auto;
			background-color: white;
			background-blend-mode: normal;
			background-repeat: 'repeat';
			background-position: center;
			background-size: 25%;
			box-shadow: inset -0.0625rem -0.0625rem #fff,
						inset 0.0625rem 0.0625rem #0a0a0a, 
						inset -0.125rem -0.125rem #dfdfdf, 
						inset 0.125rem 0.125rem #808080;
			padding: 0.625rem;
			margin-top: 0.25rem;
			margin-bottom: 0.25rem;
			display: flex;
			flex-direction: column;
			overflow-y: auto;
			scrollbar-width: none; /* Firefox */
			-ms-overflow-style: none; /* IE/Edge */
		}
		#messages-container::-webkit-scrollbar {
			display: none; /* Chrome/Safari */
		}
		.emote {
			height: 1.5rem;
			vertical-align: bottom;
			margin: -0.1rem;
		}
		#messages {
			list-style-type: none;
			margin: 0;
			padding: 0;
			margin-top: auto;
			font-size: large;
		}

		#messages > li {
			padding: 0.2rem 0.5rem; 
		}

		#messages > .e-li {
			padding: 0.2rem 0.5rem; 
			color: red;
			white-space: pre-wrap;
		}

		#messages > .i-li {
			padding: 0.2rem 0.5rem; 
			color: darkslategrey;
			white-space: pre-wrap;
		}

		#messages > .w-li {
			padding: 0.2rem 0.5rem;
			color: darkblue;
			white-space: pre-wrap;
		}

		#messages > .a-li {
			padding: 0.2rem 0.5rem; 
			color: #6eab6e;
			white-space: pre-wrap;
		}

		#messages .user-name {
			font-weight: bold;
			color: var(--user-color, black);
			margin-right: .15rem;
		}

		#messages > li:hover {
			cursor: pointer;
			background-color: rgba(0, 0, 0, 0.05);
		}
		.fake-scrollbar {
			width: 1.2rem;
			background: #dfdfdf;
			display: flex;
			flex-direction: column;
			box-shadow: inset 0.0625rem 0.0625rem #808080, inset -0.0625rem -0.0625rem #fff;
			flex-shrink: 0;
			margin: 0.25rem 0.125rem;
		}

		.fake-scroll-button {
			width: 1.2rem;
			height: 1.2rem;
			padding: 0;
			min-width: 1.2rem;
			min-height: 1.2rem;
			font-size: 0.6rem;
			display: flex;
			align-items: center;
			justify-content: center;
			background: #c0c0c0;
			border: none;

			box-shadow: 
				inset 0.0625rem 0.0625rem #fff,
				inset -0.0625rem -0.0625rem #424242,
				inset 0.125rem 0.125rem #dfdfdf,
				inset -0.125rem -0.125rem #808080
		}

		.fake-scroll-track {
			flex-grow: 1;
			position: relative;
			background-image: 
								linear-gradient(45deg, #e0e0e0 25%, transparent 25%), 
								linear-gradient(-45deg, #e0e0e0 25%, transparent 25%), 
								linear-gradient(45deg, transparent 75%, #e0e0e0 75%), 
								linear-gradient(-45deg, transparent 75%, #e0e0e0 75%);
			background-size: 0.2rem 0.2rem;
			background-position: 0 0, 0 0.1rem, 0.1rem -0.1rem, -0.1rem 0rem;
			background-color: #bcbcbc; 
			box-shadow: inset 1px 1px 0 #808080, inset -1px -1px 0 #fff;
			}

		#fake-scroll-thumb {
			width: 90%;
			height: 2rem;
			background: #c0c0c0;
			position: absolute;
			left: 50%;
			transform: translateX(-50%);
			border: none; 
			
			box-shadow: 
				inset 0.0625rem 0.0625rem #fff,
				inset -0.0625rem -0.0625rem #424242,
				inset 0.125rem 0.125rem #dfdfdf,
				inset -0.125rem -0.125rem #808080
		}
		</style>
	</head>

	<body>
	<input type="file" id="bg-upload" style="display: none;" accept="image/*">
	<div class="window">
		<div class="title-bar">
			<div class="title-bar-text">ratchat32.exe</div>
			<div class="title-bar-controls">
				<button aria-label="Minimize"></button>
				<button aria-label="Maximize"></button>
				<button aria-label="Close"></button>
			</div>
		</div>

		<div class="window-body">
			<div style="display: flex; flex-direction: row; flex-grow: 1; overflow: hidden; gap: 0rem;">
				<div id="messages-container">
					<ul id="messages"></ul>
				</div>

				<div class="fake-scrollbar">
					<button class="fake-scroll-button" id="btn-up">&#9650;</button>
					<div class="fake-scroll-track" id="track">
						<div id="fake-scroll-thumb"></div>
					</div>
					<button class="fake-scroll-button" id="btn-down">&#9660;</button>
				</div>
				
				<div id="user-sidebar">
					<ul id="user-list"></ul>
					<div id="lurker-status"></div>
				</div>
			</div>

			<form id="form" action="">
				<input id="input" type="text" autocomplete="off" />
				<button type="submit">Send</button>
			</form>
		</div>
	</div>
    <script src="https://cdn.socket.io/4.8.3/socket.io.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.3/purify.min.js" crossorigin="anonymous"></script>
	<script>
		const localGUID = localStorage.getItem('ratGUID');
		const socket = io({
		    path: "/ratchat/socket.io/",
			auth: {
			token: localGUID
			}
		});
		const form = document.getElementById('form');
		const input = document.getElementById('input');
		const messages = document.getElementById('messages');
		const savedBG = localStorage.getItem('ratBG');

		let emotes = {};

		//Helper function for non user messages
		const systemMessage = (msg, className) => {
			const item = document.createElement('li');
			const msgContainer = document.getElementById('messages-container');
			item.classList.add(className);
			item.textContent = msg;
			messages.appendChild(item);
			msgContainer.scrollTop = msgContainer.scrollHeight;
		};

		//Background loader
		document.getElementById('bg-upload').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (file) {
				const reader = new FileReader();
				
				reader.onload = function(event) {
					const imageData = event.target.result;
					document.getElementById('messages-container').style.backgroundImage = `url('${imageData}')`;
					document.getElementById('messages-container').style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
					document.getElementById('messages-container').style.backgroundBlendMode = 'overlay';
					
					//local storage
					try {
						localStorage.setItem('ratBG', imageData);
					} catch (e) {
						systemMessage("oh fuk it's too big", 'e-li')
						console.warn("image too large for localStorage");
					}
				};

				reader.readAsDataURL(file);
			}
		});

		//Fake scrollbar
		//sync thumb position to scroll
		document.getElementById('messages-container').onscroll = function() {
			document.getElementById('fake-scroll-thumb').style.top = 
				(this.scrollTop / (this.scrollHeight - this.clientHeight || 1)) * (document.getElementById('track').clientHeight - document.getElementById('fake-scroll-thumb').clientHeight) + 'px';
		};

		document.getElementById('btn-up').onclick = () => document.getElementById('messages-container').scrollBy(0, -50);
		document.getElementById('btn-down').onclick = () => document.getElementById('messages-container').scrollBy(0, 50);

		//dynamic thumb resizing using a self-executing function for the MutationObserver
		new MutationObserver(() => {
			document.getElementById('fake-scroll-thumb').style.height = 
				Math.max((document.getElementById('messages-container').clientHeight / document.getElementById('messages-container').scrollHeight) * document.getElementById('track').clientHeight, 20) + 'px';
		}).observe(document.getElementById('messages'), { childList: true });

		//sync resize event
		window.onresize = () => {
			document.getElementById('fake-scroll-thumb').style.height = 
				Math.max((document.getElementById('messages-container').clientHeight / document.getElementById('messages-container').scrollHeight) * document.getElementById('track').clientHeight, 20) + 'px';
		};
		
		//click and drag thumb
		document.getElementById('fake-scroll-thumb').addEventListener('mousedown', (e) => {
			document.onmousemove = (event) => {
				document.getElementById('messages-container').scrollTop = 
					((event.pageY - e.pageY) * (document.getElementById('messages-container').scrollHeight / document.getElementById('track').clientHeight)) + 
					(document.getElementById('messages-container').scrollTop);
				e = event;
			};
			document.onmouseup = () => {
				document.onmousemove = null;
				document.onmouseup = null;
			};
			e.preventDefault();
		});

		/////////////////////
		//Client submission//
		/////////////////////

		form.addEventListener('submit', (e) => {
			e.preventDefault();
			
			//null after trim return
			const val = input.value.trim()
			if (!val) return;

			//Export command
			if (val === '/export') {
				const oldGUID = localStorage.getItem('ratGUID');
				if (!oldGUID) {
					systemMessage("you ain't got no ID, you ain't gettin in this bar.", 'e-li');
					input.value = '';
					return;
				}
				systemMessage(`Your GUID is: ${oldGUID}`, 'i-li')
				systemMessage(`don't share it!`, 'i-li')
				input.value = '';
				return;
			}

			//Clear command
			if(val === '/clear' || val === '/clr'){
				messages.replaceChildren();
				input.value = '';
				return;
			}

			//Background command
			if (val === '/background' || val === '/bg') {
				document.getElementById('bg-upload').click();
				systemMessage("pick a file", 'i-li');
				input.value = '';
				return;
			}

			if (val === '/bgreset') {
				if(localStorage.getItem('ratBG')){
					localStorage.removeItem('ratBG');
					document.getElementById('messages-container').style.backgroundImage = '';
					document.getElementById('messages-container').style.backgroundColor = 'white';
					document.getElementById('messages-container').style.backgroundBlendMode = 'normal';
					systemMessage("background reset", 'i-li');
					input.value = '';
					return;
				}
				else{
					systemMessage('no background to reset', 'e-li');
					return;
				}
			}

			//Send message
			socket.emit('toServerChat', val, () => {
				input.value = '';
			});
		});

		//Identity events
		socket.on('identity', (identity) => {
			if (identity && identity.guid === 'RESET_IDENTITY'){
				console.log('cleared from local storage');
				localStorage.clear();
				setTimeout(() =>{systemMessage('reloading...', 'i-li');}, 200);
				setTimeout(() =>{window.location.reload();}, 2000);
			} else if(identity && identity.guid) {
				localStorage.setItem('ratGUID', identity.guid);
				console.log('identity loaded')
			} else{
				console.log('identity load error')
			}
		});

		//Emote events
		socket.on('emote', (payload) =>{
			emotes = payload;
		});

		//User list events
		socket.on('userlist', (uList) => {
			const userListElement = document.getElementById('user-list');
			const lurkerElement = document.getElementById('lurker-status');
			userListElement.replaceChildren();

			let lurkerData = null;

			//build consolidated listing
			const consolidate = new Map();
			uList.forEach(user =>{
				if (user.nick.startsWith('#NONVAL')) {
					lurkerData = user;
					return;
				}
				if (consolidate.has(user.nick)){
					consolidate.get(user.nick).count++;
				}
				else{
					consolidate.set(user.nick, {...user, count: 1})
				}
			});

			consolidate.forEach(user => {
				const li = document.createElement('li');
				li.style.marginBottom = "0.125rem";
				
				const userColor = user.nick.substring(0, 7);
				const userName = user.nick.substring(7);

				const orb = user.isAfk ? 'orb-afk' : 'orb-online';
				const orbLabel = user.isAfk ? 'AFK' : 'Online'

				const statusText = user.status ? `<div style="font-size:small; color: #444; margin-left: 0.375rem;">${user.status}</div>` : '';

				let displayCount = ''

				if(user.count >9){
					//no hiscores
					displayCount = '&nbsp;&nbsp;(a lot)';
				}
				else if(user.count > 1){
					displayCount = `&nbsp;&nbsp;(${user.count})`;
				}

				const dirty = (`
					<span class="status-orb ${orb}" title="${orbLabel}"></span><span style="color: ${userColor}; font-weight: bold;">${userName}</span><span style="color: darkslategrey; font-size: medium;">${displayCount}</span>
					${statusText}
				`);
				if (window.DOMPurify){
					li.innerHTML = DOMPurify.sanitize(dirty);
				}
				else{
					li.textContent = `${userName}${user.status ? ` (${user.status})` : ''}`;
					li.style.color = userColor	
				}
				userListElement.appendChild(li);
			});

			lurkerElement.textContent = `lurkers: ${lurkerData.status}`;
		});

		//Delete message events
		socket.on('deleteMsg', (msgArray) => {
			if(!Array.isArray(msgArray)){
				return;
			}
			msgArray.forEach(id => {
				const target = document.querySelector(`li[data-id="${id}"]`)
				if(target){
					target.replaceChildren('[message deleted]');
					target.className = 'i-li';
					target.removeAttribute('title');
				}
			});
		});


		//message type to css class
		const toClass = {
			'toClientChat': '',
			'toClientError': 'e-li',
			'toClientInfo': 'i-li',
			'toClientWelcome': 'w-li',
			'toClientAnnouncement': 'a-li'
		};

		//message renderer
		const renderMessage =(msg) =>{
			
			const item = document.createElement('li');
			const msgContainer = document.getElementById('messages-container');

			//message type classification
			const className = toClass[msg.type];
			if (className) item.classList.add(className);

			//Date constructor
			if(msg.id !== -1){
			const date = new Date(msg.timestamp);
			const dateStr = date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
			const timeSpan = document.createElement('span');
				timeSpan.textContent = dateStr;
				timeSpan.style = "color:grey; font-size:small; margin-right:0.5rem"
			item.appendChild(timeSpan);
			}

			//Nickname constructor and styling
			if(msg.id !== -1 && msg.author){
			const userName = msg.author.substring(7);
			const userColor = msg.author.substring(0,7);
			const nameSpan = document.createElement('span');
			nameSpan.className = "user-name";
				nameSpan.style.setProperty('--user-color', userColor);
				nameSpan.textContent = userName + ":";
			item.appendChild(nameSpan)

			//set hover msg ID and data ID
			item.setAttribute('title', `Msg ID: ${msg.id}`);
			item.setAttribute('data-id', msg.id);
			}

			//emotify function
			const emotify = (text) =>{
				return text.split(' ').map(word => {
					if (emotes[word]) {
						return `<img src="${emotes[word]}" title="${word}" alt="${word}" class="emote" crossorigin="anonymous">`;
					}
				return word;
				}).join(' ');
			};

			//Message content
			const contentSpan = document.createElement('span')

			if(window.DOMPurify && msg.id !== -1){
				const raw = emotify(msg.content)
				contentSpan.innerHTML = DOMPurify.sanitize(raw);
			}
			else{
				contentSpan.textContent = msg.content;
			}
			
			item.appendChild(contentSpan);

			//finalize
			messages.appendChild(item);
			msgContainer.scrollTop = msgContainer.scrollHeight;
		};

		//message listeners
		socket.on('toClientChat', renderMessage);
		socket.on('toClientError', renderMessage);
		socket.on('toClientInfo', renderMessage);
		socket.on('toClientWelcome', renderMessage);
		socket.on('toClientAnnouncement', renderMessage);

		//background load from storage
		if (savedBG) {
			document.getElementById('messages-container').style.backgroundImage = `url('${savedBG}')`;
			document.getElementById('messages-container').style.backgroundColor = 'rgba(255, 255, 255, 0.5)';
			document.getElementById('messages-container').style.backgroundBlendMode = 'overlay';
		}
		
		input.focus();
	</script>
	</body>
</html>